@page "/reminders"
@using MedicineReminder.Models
@using MedicineReminder.Services
@inject DataService DataService
@inject NavigationManager Navigation

<div class="reminders-container">
    <div class="page-header">
        <h2>‚è∞ –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –ø—Ä–∏—ë–º—ã</h2>
        <button class="btn btn-secondary" @onclick="GoBack">
            ‚Üê –ù–∞–∑–∞–¥
        </button>
    </div>

    @if (groupedReminders.Any())
    {
        @foreach (var group in groupedReminders)
        {
            <div class="reminder-group">
                <h3 class="group-date">@GetDateLabel(group.Key)</h3>
                <div class="reminder-items">
                    @foreach (var reminder in group.Value)
                    {
                        var medicine = medicines.FirstOrDefault(m => m.Id == reminder.MedicineId);
                        if (medicine != null)
                        {
                            <div class="reminder-card @(reminder.IsCompleted ? "completed" : "")">
                                <div class="reminder-time-badge">
                                    @reminder.ScheduledTime.ToString("HH:mm")
                                </div>
                                <div class="reminder-info">
                                    <h4>@medicine.Name</h4>
                                    <p>@medicine.Dosage</p>
                                    @if (!string.IsNullOrEmpty(medicine.Notes))
                                    {
                                        <p class="reminder-notes">@medicine.Notes</p>
                                    }
                                </div>
                                <div class="reminder-status">
                                    @if (reminder.IsCompleted)
                                    {
                                        <span class="status-completed">
                                            ‚úì –ü—Ä–∏–Ω—è—Ç–æ
                                            @if (reminder.CompletedTime.HasValue)
                                            {
                                                <span>(@reminder.CompletedTime.Value.ToString("HH:mm"))</span>
                                            }
                                        </span>
                                    }
                                    else if (reminder.ScheduledTime < DateTime.Now)
                                    {
                                        <div class="status-actions">
                                            <span class="status-overdue">‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ</span>
                                            <button class="btn btn-sm btn-success" @onclick="() => CompleteReminder(reminder.Id)">
                                                –û—Ç–º–µ—Ç–∏—Ç—å
                                            </button>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="status-upcoming">üìÖ –ü—Ä–µ–¥—Å—Ç–æ–∏—Ç</span>
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        }
    }
    else
    {
        <div class="empty-state">
            <p>üì≠ –ù–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π</p>
            <button class="btn btn-primary" @onclick="GoToAddMedicine">
                –î–æ–±–∞–≤–∏—Ç—å –ª–µ–∫–∞—Ä—Å—Ç–≤–æ
            </button>
        </div>
    }
</div>

@code {
    private List<Medicine> medicines = new();
    private Dictionary<DateTime, List<Reminder>> groupedReminders = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        medicines = await DataService.GetAllMedicinesAsync();
        var allReminders = await DataService.GetAllRemindersAsync();

        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ –¥–∞—Ç–∞–º
        groupedReminders = allReminders
            .Where(r => r.ScheduledTime >= DateTime.Today.AddDays(-7)) // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
            .OrderBy(r => r.ScheduledTime)
            .GroupBy(r => r.ScheduledTime.Date)
            .ToDictionary(g => g.Key, g => g.ToList());
    }

    private async Task CompleteReminder(Guid reminderId)
    {
        await DataService.MarkReminderAsCompletedAsync(reminderId);
        await LoadData();
    }

    private string GetDateLabel(DateTime date)
    {
        var today = DateTime.Today;
        if (date == today)
            return "–°–µ–≥–æ–¥–Ω—è";
        if (date == today.AddDays(1))
            return "–ó–∞–≤—Ç—Ä–∞";
        if (date == today.AddDays(-1))
            return "–í—á–µ—Ä–∞";
        
        return date.ToString("dd MMMM yyyy", new System.Globalization.CultureInfo("ru-RU"));
    }

    private void GoBack() => Navigation.NavigateTo("/");
    private void GoToAddMedicine() => Navigation.NavigateTo("/add-medicine");
}
