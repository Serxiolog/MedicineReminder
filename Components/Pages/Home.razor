@page "/"
@using MedicineReminder.Models
@using MedicineReminder.Services
@inject DataService DataService
@inject NavigationManager Navigation

<div class="home-container">
    <div class="button-group">
        <button class="btn btn-primary" @onclick="GoToMedicines">
            üìã –ú–æ–∏ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞
        </button>
        <button class="btn btn-success" @onclick="GoToReminders">
            ‚è∞ –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –ø—Ä–∏—ë–º—ã
        </button>
        <button class="btn btn-info" @onclick="GoToAddMedicine">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ª–µ–∫–∞—Ä—Å—Ç–≤–æ
        </button>
    </div>

    <div class="info-section">
        <h3>–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</h3>
        @if (todayReminders.Any())
        {
            <ul class="reminder-list">
                @foreach (var reminder in todayReminders)
                {
                    var medicine = medicines.FirstOrDefault(m => m.Id == reminder.MedicineId);
                    if (medicine != null)
                    {
                        <li class="reminder-item @(reminder.IsCompleted ? "completed" : "")">
                            <div class="reminder-time">@reminder.ScheduledTime.ToString("HH:mm")</div>
                            <div class="reminder-details">
                                <strong>@medicine.Name</strong>
                                <span>@medicine.Dosage</span>
                            </div>
                            @if (!reminder.IsCompleted)
                            {
                                <button class="btn-complete" @onclick="() => CompleteReminder(reminder.Id)">‚úì</button>
                            }
                            else
                            {
                                <span class="completed-badge">–ü—Ä–∏–Ω—è—Ç–æ</span>
                            }
                        </li>
                    }
                }
            </ul>
        }
        else
        {
            <p class="empty-message">–ù–∞ —Å–µ–≥–æ–¥–Ω—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –Ω–µ—Ç</p>
        }
    </div>

    <div class="stats-section">
        <div class="stat-card">
            <div class="stat-number">@medicines.Count</div>
            <div class="stat-label">–õ–µ–∫–∞—Ä—Å—Ç–≤ –≤ —Å–ø–∏—Å–∫–µ</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">@upcomingCount</div>
            <div class="stat-label">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –ø—Ä–∏—ë–º–æ–≤</div>
        </div>
    </div>
</div>

@code {
    private List<Medicine> medicines = new();
    private List<Reminder> todayReminders = new();
    private int upcomingCount = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        medicines = await DataService.GetAllMedicinesAsync();
        var allReminders = await DataService.GetAllRemindersAsync();
        
        var today = DateTime.Today;
        todayReminders = allReminders
            .Where(r => r.ScheduledTime.Date == today)
            .OrderBy(r => r.ScheduledTime)
            .ToList();

        upcomingCount = allReminders.Count(r => !r.IsCompleted && r.ScheduledTime > DateTime.Now);
    }

    private async Task CompleteReminder(Guid reminderId)
    {
        await DataService.MarkReminderAsCompletedAsync(reminderId);
        await LoadData();
    }

    private void GoToMedicines() => Navigation.NavigateTo("/medicines");
    private void GoToReminders() => Navigation.NavigateTo("/reminders");
    private void GoToAddMedicine() => Navigation.NavigateTo("/add-medicine");
}
