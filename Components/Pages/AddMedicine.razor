@page "/add-medicine"
@using MedicineReminder.Models
@using MedicineReminder.Services
@inject DataService DataService
@inject INotificationService NotificationService
@inject NavigationManager Navigation

<div class="form-container">
    <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å –ª–µ–∫–∞—Ä—Å—Ç–≤–æ</h2>

    <EditForm Model="medicine" OnValidSubmit="HandleSubmit">
        <div class="form-group">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞ *</label>
            <InputText @bind-Value="medicine.Name" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê—Å–ø–∏—Ä–∏–Ω" />
            @if (string.IsNullOrWhiteSpace(medicine.Name) && showValidation)
            {
                <span class="validation-error">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</span>
            }
        </div>

        <div class="form-group">
            <label>–î–æ–∑–∏—Ä–æ–≤–∫–∞ *</label>
            <InputText @bind-Value="medicine.Dosage" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1 —Ç–∞–±–ª–µ—Ç–∫–∞" />
            @if (string.IsNullOrWhiteSpace(medicine.Dosage) && showValidation)
            {
                <span class="validation-error">–í–≤–µ–¥–∏—Ç–µ –¥–æ–∑–∏—Ä–æ–≤–∫—É</span>
            }
        </div>

        <div class="form-group">
            <label>–ß–∞—Å—Ç–æ—Ç–∞ –ø—Ä–∏—ë–º–∞ *</label>
            <InputText @bind-Value="medicine.Frequency" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å" />
            @if (string.IsNullOrWhiteSpace(medicine.Frequency) && showValidation)
            {
                <span class="validation-error">–í–≤–µ–¥–∏—Ç–µ —á–∞—Å—Ç–æ—Ç—É</span>
            }
        </div>

        <div class="form-group">
            <label>–í—Ä–µ–º—è –ø—Ä–∏—ë–º–∞ *</label>
            <InputDate Type="InputDateType.Time" @bind-Value="medicine.Time" class="form-control" />
        </div>

        <div class="form-group">
            <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
            <InputDate @bind-Value="medicine.StartDate" class="form-control" />
        </div>

        <div class="form-group">
            <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <InputDate @bind-Value="endDate" class="form-control" />
        </div>

        <div class="form-group">
            <label>–î–Ω–∏ –Ω–µ–¥–µ–ª–∏</label>
            <div class="days-selector">
                @foreach (DayOfWeek day in Enum.GetValues(typeof(DayOfWeek)))
                {
                    <label class="day-checkbox">
                        <input type="checkbox" 
                               checked="@medicine.SelectedDays.Contains(day)"
                               @onchange="@(e => ToggleDay(day, (bool)e.Value!))" />
                        <span>@GetDayName(day)</span>
                    </label>
                }
            </div>
        </div>

        <div class="form-group">
            <label>–ó–∞–º–µ—Ç–∫–∏</label>
            <InputTextArea @bind-Value="medicine.Notes" class="form-control" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..." />
        </div>

        <div class="form-group">
            <label class="checkbox-label">
                <InputCheckbox @bind-Value="medicine.IsActive" />
                <span>–ê–∫—Ç–∏–≤–Ω–æ</span>
            </label>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }

        <div class="form-actions">
            <button type="submit" class="btn btn-success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button type="button" class="btn btn-secondary" @onclick="Cancel">‚ùå –û—Ç–º–µ–Ω–∞</button>
        </div>
    </EditForm>
</div>

@code {
    private Medicine medicine = new() { StartDate = DateTime.Today };
    private DateTime? endDate;
    private bool showValidation = false;
    private string errorMessage = string.Empty;

    private void ToggleDay(DayOfWeek day, bool isChecked)
    {
        if (isChecked && !medicine.SelectedDays.Contains(day))
        {
            medicine.SelectedDays.Add(day);
        }
        else if (!isChecked && medicine.SelectedDays.Contains(day))
        {
            medicine.SelectedDays.Remove(day);
        }
    }

    private async Task HandleSubmit()
    {
        showValidation = true;
        errorMessage = string.Empty;

        if (string.IsNullOrWhiteSpace(medicine.Name) || 
            string.IsNullOrWhiteSpace(medicine.Dosage) || 
            string.IsNullOrWhiteSpace(medicine.Frequency))
        {
            errorMessage = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è";
            return;
        }

        try
        {
            medicine.EndDate = endDate;

            await DataService.AddMedicineAsync(medicine);
            await DataService.GenerateRemindersForMedicineAsync(medicine);

            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            await NotificationService.RequestPermissionsAsync();

            // –ü–ª–∞–Ω–∏—Ä—É–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            var reminders = await DataService.GetRemindersByMedicineIdAsync(medicine.Id);
            foreach (var reminder in reminders.Where(r => !r.IsCompleted))
            {
                await NotificationService.ScheduleNotificationAsync(reminder, medicine);
            }

            Navigation.NavigateTo("/medicines");
        }
        catch (Exception ex)
        {
            errorMessage = $"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: {ex.Message}";
        }
    }

    private void Cancel() => Navigation.NavigateTo("/medicines");

    private string GetDayName(DayOfWeek day)
    {
        return day switch
        {
            DayOfWeek.Monday => "–ü–Ω",
            DayOfWeek.Tuesday => "–í—Ç",
            DayOfWeek.Wednesday => "–°—Ä",
            DayOfWeek.Thursday => "–ß—Ç",
            DayOfWeek.Friday => "–ü—Ç",
            DayOfWeek.Saturday => "–°–±",
            DayOfWeek.Sunday => "–í—Å",
            _ => day.ToString()
        };
    }
}
