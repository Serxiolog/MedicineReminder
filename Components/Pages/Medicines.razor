@page "/medicines"
@using MedicineReminder.Models
@using MedicineReminder.Services
@inject DataService DataService
@inject NavigationManager Navigation

<div class="medicines-container">
    <div class="page-header">
        <h2>üìã –ú–æ–∏ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞</h2>
        <button class="btn btn-primary" @onclick="GoToAddMedicine">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å
        </button>
    </div>

    @if (medicines.Any())
    {
        <div class="medicines-list">
            @foreach (var medicine in medicines)
            {
                <div class="medicine-card @(medicine.IsActive ? "" : "inactive")">
                    <div class="medicine-header">
                        <h3>@medicine.Name</h3>
                        <span class="badge @(medicine.IsActive ? "badge-active" : "badge-inactive")">
                            @(medicine.IsActive ? "–ê–∫—Ç–∏–≤–Ω–æ" : "–ù–µ–∞–∫—Ç–∏–≤–Ω–æ")
                        </span>
                    </div>
                    
                    <div class="medicine-details">
                        <div class="detail-item">
                            <span class="detail-label">üíä –î–æ–∑–∏—Ä–æ–≤–∫–∞:</span>
                            <span>@medicine.Dosage</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">‚è∞ –í—Ä–µ–º—è:</span>
                            <span>@medicine.Time.ToString("HH:mm")</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">üìÖ –ß–∞—Å—Ç–æ—Ç–∞:</span>
                            <span>@medicine.Frequency</span>
                        </div>
                        @if (medicine.SelectedDays.Any())
                        {
                            <div class="detail-item">
                                <span class="detail-label">üìÜ –î–Ω–∏:</span>
                                <span>@string.Join(", ", medicine.SelectedDays.Select(d => GetDayName(d)))</span>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(medicine.Notes))
                        {
                            <div class="detail-item">
                                <span class="detail-label">üìù –ó–∞–º–µ—Ç–∫–∏:</span>
                                <span>@medicine.Notes</span>
                            </div>
                        }
                    </div>

                    <div class="medicine-actions">
                        <button class="btn btn-sm btn-info" @onclick="() => EditMedicine(medicine.Id)">
                            ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å
                        </button>
                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteMedicine(medicine.Id)">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty-state">
            <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –ª–µ–∫–∞—Ä—Å—Ç–≤</p>
            <button class="btn btn-primary" @onclick="GoToAddMedicine">
                –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤–æ–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–æ
            </button>
        </div>
    }

    <div class="navigation-buttons">
        <button class="btn btn-secondary" @onclick="GoBack">
            ‚Üê –ù–∞–∑–∞–¥
        </button>
    </div>
</div>

@code {
    private List<Medicine> medicines = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadMedicines();
    }

    private async Task LoadMedicines()
    {
        medicines = await DataService.GetAllMedicinesAsync();
    }

    private void EditMedicine(Guid id)
    {
        Navigation.NavigateTo($"/edit-medicine/{id}");
    }

    private async Task DeleteMedicine(Guid id)
    {
        if (await ConfirmDelete())
        {
            await DataService.DeleteMedicineAsync(id);
            await LoadMedicines();
        }
    }

    private async Task<bool> ConfirmDelete()
    {
        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        return await Task.FromResult(true);
    }

    private void GoToAddMedicine() => Navigation.NavigateTo("/add-medicine");
    private void GoBack() => Navigation.NavigateTo("/");

    private string GetDayName(DayOfWeek day)
    {
        return day switch
        {
            DayOfWeek.Monday => "–ü–Ω",
            DayOfWeek.Tuesday => "–í—Ç",
            DayOfWeek.Wednesday => "–°—Ä",
            DayOfWeek.Thursday => "–ß—Ç",
            DayOfWeek.Friday => "–ü—Ç",
            DayOfWeek.Saturday => "–°–±",
            DayOfWeek.Sunday => "–í—Å",
            _ => day.ToString()
        };
    }
}
